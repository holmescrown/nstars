# 代码合并记录

## 最近更改

### 1. 物理引擎改进 (`src/wasm_physics_engine.ts`)
- **使用真实重力**：移除了虚假的"排斥力"和"速度锁定"逻辑
- **增加子步数**：将 subSteps 从 5 增加到 10，以获得更平滑的轨道
- **添加软化因子**：使用 `const distSq = dx * dx + dy * dy + dz * dz + 50;` 避免奇点
- **新增边界回归**：添加向心微扰力，防止天体飞出边界
- **新增护盾干预**：接收 `shield_power`，激活时施加强大的阻尼和向心力
- **新增系统半径计算**：计算系统最大逃逸半径用于触发前端警报
- **关键更改**：实现了真实的万有引力计算，提高了物理模拟的准确性
- **边界回归参数**：`BOUNDARY = 500`（触发半径），`CENTRIPETAL_K = 2.0`（拉力系数），护盾激活时放大 10 倍

### 2. 前端数据结构修复与预警系统 (`public/main.js`)
- **移除 THREE 依赖**：不再使用 `THREE.Vector3`，改为纯数据对象
- **修复数据提取**：从后端数据中正确提取 targetX, targetY, targetZ
- **新增大撕裂预警**：根据 `system_radius` 动态改变屏幕 CSS 状态
- **关键更改**：使用 `targetX: b.x, targetY: b.y, targetZ: b.z || 0` 确保数据格式正确，添加屏幕红色预警效果

### 3. 平滑动画实现 (`public/js/core/Engine.js`)
- **添加目标位置存储**：新增 `targetBodies` 属性存储后端传来的目标位置
- **实现手动插值**：使用原生数学实现 Lerp 插值，确保 60fps 平滑动画
- **关键更改**：`bodyData.mesh.position.x += (target.targetX - bodyData.mesh.position.x) * 0.1;`

### 4. 轨迹效果改进、视界追踪与移动端沉浸 (`public/js/render/SceneManager.js`)
- **启用顶点颜色**：设置 `trailMaterial.vertexColors = true;` 支持渐变效果
- **添加轨迹更新方法**：实现 `updateTrail` 方法，计算渐变颜色
- **新增视界自动追踪**：实现 Focus Mode，平滑追踪系统质心
- **新增历史虚影边界**：添加半透明线框球体，显示系统最大边界
- **新增移动端陀螺仪沉浸**：监听 deviceorientation 并实现视差旋转
- **关键更改**：通过顶点颜色计算实现自然的轨迹渐变效果，使用 `controls.target.lerp` 实现平滑相机追踪，添加 `setupGyro` 方法实现移动端沉浸

### 5. 文明状态机与混沌律计算 (`src/LifeCycleManager.ts`)
- **新增混沌律计算**：实现 `calculateChaosLevel` 方法，基于速度方差和系统半径计算混沌指数
- **修改环境判定**：从单一辐射逻辑升级为混沌律计算
- **更新干预处理**：修改 `handleIntervention` 方法，注入护盾能量
- **修复 DO 崩溃陷阱**：添加 try-catch 捕获 AI 预警生成失败，确保异步存储操作正确使用 await
- **激活 AI 播报**：生成富有文学感的文明预警，包含降级机制
- **新增惰性生命周期机制**：添加 `startLoop` 和 `stopLoop` 方法，实现按需启动和停止物理引擎
- **关键更改**：混沌指数 = (平均速度 * 0.5) + (系统半径 * 0.01)，归一化到 0-1

### 6. 前端 UI 联动补完 (`public/js/ui/UIManager.js`)
- **增强消息显示**：更新 `showMessage` 方法，支持 AI 报告的解析和格式化
- **优化显示时间**：AI 报告显示时间延长到 8 秒，普通消息保持 3 秒
- **添加 Markdown 支持**：自动将消息中的换行符转换为 HTML 换行
- **关键更改**：使用 `innerHTML` 替代 `textContent`，支持富文本消息显示

### 7. Worker 路由改造与 WebSocket 联动 (`src/worker.ts`)
- **新增 WebSocket 连接管理**：根据连接数动态启动/停止物理引擎
- **添加 WebSocket 升级头检查**：确保 Cloudflare 稳定连接
- **实现统一清理逻辑**：当所有玩家退出时停止引擎，节省 CPU
- **关键更改**：`if (this.connections.size === 1) { this.manager.startLoop(); }` 和 `if (this.connections.size === 0) { this.manager.stopLoop(); }`

## 技术要点

- **60fps 插值**：使用手动 Lerp 算法确保平滑动画
- **纯数据传输**：前端和后端之间使用纯数据对象，减少依赖
- **物理精度**：增加子步数和使用真实重力模型提高模拟准确性
- **轨迹渲染**：使用顶点颜色实现优雅的渐变轨迹效果
- **视界自动追踪**：实现 Focus Mode，平滑追踪系统质心
- **大撕裂预警**：基于系统半径的视觉预警系统
- **护盾干预**：激活时施加强大的阻尼和向心力
- **混沌律计算**：基于速度方差和系统半径的动态混沌程度计算
- **历史虚影边界**：半透明线框球体显示系统最大边界
- **移动端陀螺仪沉浸**：实现 deviceorientation 视差旋转，增强移动端体验
- **惰性生命周期机制**：按需启动/停止物理引擎，节省 CPU 资源
- **WebSocket 联动**：根据连接数动态管理物理引擎状态
- **AI 文明预警**：生成富有文学感的文明预警，包含降级机制

## 修复的问题

1. **运动卡顿**：通过实现 60fps 插值解决
2. **物理不真实**：移除虚假物理逻辑，使用真实重力
3. **轨迹光污染**：优化轨迹材质和渐变计算
4. **THREE 依赖错误**：修复 main.js 中未导入 THREE 导致的 ReferenceError
5. **视角不稳定**：实现视界自动追踪，平滑跟随系统质心
6. **系统崩溃预警**：添加大撕裂红色预警，提前通知系统不稳定
7. **文明状态单一**：实现基于混沌律的动态文明状态机
8. **干预机制缺失**：添加护盾能量注入，实现物理引擎重置
9. **边界感知缺失**：添加历史虚影边界，直观显示系统最大范围
10. **移动端体验差**：实现陀螺仪沉浸视角，增强移动端交互体验
11. **DO 崩溃陷阱**：添加 try-catch 捕获 AI 预警生成失败，确保异步存储操作正确使用 await
12. **CPU 资源浪费**：实现惰性生命周期机制，按需启动/停止物理引擎
13. **WebSocket 不稳定**：添加升级头检查，确保 Cloudflare 稳定连接
14. **AI 预警失败**：添加降级机制，确保文明预警功能可靠运行
